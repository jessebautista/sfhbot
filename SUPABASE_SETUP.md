# Supabase Setup Guide for SFH Bot

## Quick Setup Steps

### 1. Run the SQL Setup File

1. **Open your Supabase Dashboard**
2. **Go to SQL Editor**
3. **Copy and paste** the entire contents of `supabase_setup.sql`
4. **Click "Run"** to execute the setup

### 2. Verify Setup

After running the SQL file, you should see:
- ‚úÖ "Setup completed successfully!"
- ‚úÖ Knowledge documents created: 8
- ‚úÖ Tables, functions, and indexes created

### 3. Update Your Environment

Add your Supabase credentials to `.env`:

```env
SUPABASE_URL=https://your-project-ref.supabase.co
SUPABASE_ANON_KEY=your-anon-key-here
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here
```

## What Gets Created

### üìä **Tables**
- **`knowledge_documents`** - Organizational knowledge base with vector embeddings
- **`chat_logs`** - Conversation history and analytics
- **`user_sessions`** - Anonymous user tracking and preferences

### üîç **Functions**
- **`search_knowledge_documents()`** - Semantic search for knowledge base
- **`get_chat_analytics()`** - Chat statistics and metrics
- **`update_user_session()`** - User activity tracking
- **`cleanup_old_data()`** - Privacy compliance data cleanup

### üìö **Initial Data**
- **8 knowledge documents** covering:
  - Organization info and mission
  - Donation processes and tax info
  - Volunteer opportunities and training
  - Events and community programs
  - Contact information and hours
  - Financial transparency
  - Privacy policy

### üõ°Ô∏è **Security**
- **Row Level Security (RLS)** enabled
- **Proper permissions** for anonymous and authenticated users
- **Privacy-compliant** data retention policies

## Testing the Setup

### 1. Test Vector Search (Optional - requires OpenAI integration)

```sql
-- This will work once embeddings are generated by your app
SELECT title, content, similarity 
FROM search_knowledge_documents(
  (SELECT embedding FROM knowledge_documents LIMIT 1), -- sample embedding
  0.5, -- threshold
  3    -- limit
);
```

### 2. Test Analytics Function

```sql
-- Get chat analytics for the last 7 days
SELECT * FROM get_chat_analytics();
```

### 3. Verify Tables

```sql
-- Check knowledge base
SELECT title, category, priority FROM knowledge_documents ORDER BY priority DESC;

-- Check if tables are ready
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('knowledge_documents', 'chat_logs', 'user_sessions');
```

## Important Notes

### Vector Embeddings
- **Embeddings are generated by your application** using OpenAI's API
- **First API calls** will populate the embedding column
- **Vector search** becomes available after embeddings are created

### Privacy & Compliance
- **Automatic cleanup** function for old data
- **User data deletion** capabilities built-in  
- **RLS policies** protect user privacy

### Performance
- **Optimized indexes** for fast queries
- **Vector index** for similarity search
- **Efficient analytics** functions

## Troubleshooting

### Issue: "extension 'vector' does not exist"
**Solution**: Vector extension might not be available in your Supabase plan. Contact Supabase support or use the fallback knowledge search.

### Issue: Permission denied errors
**Solution**: Make sure you're using the SQL Editor as the database owner, not as an authenticated user.

### Issue: Functions not found
**Solution**: Re-run the SQL setup file. The functions should be created in the `public` schema.

## Next Steps

1. **Start your application**: `npm run dev`
2. **Test chat functionality** - The app will automatically populate embeddings
3. **Monitor the chat_logs table** to see conversations being stored
4. **Use the analytics functions** to track usage

Your Supabase database is now ready for the SFH Bot! üéâ